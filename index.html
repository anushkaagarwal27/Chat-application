<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Chat</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</head>

<body>
    <div class="app">
        <aside class="sidebar">
            <h2><i class="fas fa-comments"></i> ChatSpace by Annieüê¨</h2>
            
            <div>
                <input id="username" placeholder="Enter your name..." autocomplete="off" /><br><br>
                <input id="room" placeholder="Room Name (e.g. dev)" autocomplete="off" />
                <button id="join">Join Room <i class="fas fa-arrow-right"></i></button>
            </div>

            <h3><i class="fas fa-users"></i> Online Users</h3>
            <ul id="online-users"></ul>
        </aside>

        <section class="chat-window">
            <header class="chat-header">
                <h3 id="room-name">Room: <span style="opacity:0.6;">(Join a room)</span></h3>
                <div id="room-tabs" class="room-tabs"></div>
            </header>

            <main id="chat" class="chat-area">
                <div class="meta system" style="margin-top: 50px;">Welcome! Join a room to start chatting.</div>
            </main>

            <footer class="chat-footer">
                <button id="emoji-btn">üòä</button>
                <input id="message" placeholder="Type your message..." autocomplete="off" />
                <button id="send"><i class="fas fa-paper-plane"></i></button>
                
                <emoji-picker id="emoji-picker" 
                    style="display:none; position:absolute; bottom:80px; left:20px;">
                </emoji-picker>
            </footer>
        </section>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- CONFIGURATION ---
        // If deploying, replace io() with io("https://your-render-url.com")
        const socket = io(); 

        const chat = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const usernameInput = document.getElementById('username');
        const roomInput = document.getElementById('room');
        const sendBtn = document.getElementById('send');
        const joinBtn = document.getElementById('join');
        const roomNameDisplay = document.getElementById('room-name');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const onlineList = document.getElementById('online-users');
        const roomTabs = document.getElementById('room-tabs');

        let joinedRooms = new Set();
        let activeRoom = null;
        
        // NEW: Store all messages for all rooms here
        const messageHistory = {}; 
        const unreadCounts = {};

        function formatTime(t) {
            return new Date(Number(t)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // JUST RENDER (Doesn't check room, just draws what it's given)
        function renderMessage({ user, msg, time, id }, isSystem = false) {
            const isSelf = user === (usernameInput.value || 'Anonymous').trim();
            const wrapper = document.createElement('div');
            wrapper.className = `message ${isSelf ? 'sent' : 'received'}`;
            wrapper.dataset.id = id;

            const bubble = document.createElement('div');
            bubble.className = 'bubble';

            if (isSystem) {
                wrapper.innerHTML = `<div class="meta system">${msg}</div>`;
                wrapper.className = 'message system-wrapper';
                wrapper.style.justifyContent = 'center';
            } else {
                bubble.innerHTML = `
                    <div class="text">${msg}</div>
                    <div class="meta">
                        ${isSelf ? '' : user + ' ‚Ä¢'} ${formatTime(time)}
                        <span class="read" style="display:none; color: #aef;">‚úì‚úì</span>
                    </div>`;
                wrapper.appendChild(bubble);
            }

            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight; // Auto-scroll to bottom
        }

        function switchRoom(room) {
            activeRoom = room;
            roomNameDisplay.innerHTML = `Room: <b>${room}</b>`;
            
            // 1. Clear the screen
            chat.innerHTML = '';
            
            // 2. Restore history for this room (if any)
            if (messageHistory[room]) {
                messageHistory[room].forEach(data => {
                    // Check if it's a system message or user message based on data structure
                    // For simplicity, we assume user messages here unless marked otherwise
                    // In this simple app, we can detect system messages if they lack an ID or have specific flag
                    // But your server sends slightly different payloads.
                    
                    // We'll trust the stored data.
                    renderMessage(data, data.isSystem);
                });
            }

            // 3. Update Tabs UI
            document.querySelectorAll('.room-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.room-tab[data-room="${room}"]`);
            if(activeTab) activeTab.classList.add('active');

            unreadCounts[room] = 0;
            updateRoomTabBadge(room);
        }

        function updateRoomTabBadge(room) {
            const tab = document.querySelector(`.room-tab[data-room="${room}"]`);
            if (tab) {
                const count = unreadCounts[room] || 0;
                const badge = tab.querySelector('.badge');
                badge.textContent = count > 0 ? count : '';
                badge.style.display = count > 0 ? 'block' : 'none';
            }
        }

        function addRoomTab(room) {
            const tab = document.createElement('button');
            tab.className = 'room-tab';
            tab.dataset.room = room;
            tab.innerHTML = `${room} <span class="badge" style="display:none"></span>`;
            tab.onclick = () => switchRoom(room);
            roomTabs.appendChild(tab);
        }

        joinBtn.onclick = () => {
            const room = (roomInput.value || 'general').trim();
            const user = (usernameInput.value || 'Anonymous').trim();
            
            if(!room || !user) {
                alert("Please enter both a Name and a Room!");
                return;
            }

            if (!joinedRooms.has(room)) {
                socket.emit('join room', { room, user });
                joinedRooms.add(room);
                addRoomTab(room);
                // Initialize history for this room
                if (!messageHistory[room]) messageHistory[room] = [];
            }
            switchRoom(room);
        };

        sendBtn.onclick = () => {
            if (!activeRoom) {
                alert("Join a room first!");
                return;
            }
            const msg = messageInput.value.trim();
            if (!msg) return;
            const user = (usernameInput.value || 'Anonymous').trim();
            socket.emit('chat message', { room: activeRoom, user, msg });
            messageInput.value = '';
        };

        messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') sendBtn.onclick();
        });

        // EMOJI LOGIC
        emojiBtn.onclick = (e) => {
            e.stopPropagation();
            const isVisible = emojiPicker.style.display === 'block';
            emojiPicker.style.display = isVisible ? 'none' : 'block';
        };
        emojiPicker.addEventListener('emoji-click', e => {
            messageInput.value += e.detail.unicode;
        });
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });

        // --- SOCKET EVENTS ---

        socket.on('chat message', data => {
            // 1. Save to History
            if (!messageHistory[data.room]) messageHistory[data.room] = [];
            messageHistory[data.room].push(data);

            // 2. Render ONLY if we are looking at that room
            if (data.room === activeRoom) {
                renderMessage(data);
                socket.emit('message read', { room: activeRoom, msgId: data.id });
            } else {
                unreadCounts[data.room] = (unreadCounts[data.room] || 0) + 1;
                updateRoomTabBadge(data.room);
            }
        });

        socket.on('system message', data => {
            // Mark as system for our renderer
            data.isSystem = true; 
            
            if (!messageHistory[data.room]) messageHistory[data.room] = [];
            messageHistory[data.room].push(data);

            if (data.room === activeRoom) renderMessage(data, true);
        });

        socket.on('online users', users => {
            onlineList.innerHTML = users.map(u => `<li>${u.user}</li>`).join('');
        });
    </script>
</body>

</html>


